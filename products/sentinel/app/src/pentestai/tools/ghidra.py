import os
import tempfile
import textwrap
import logging
from .subproc import run, which

logger = logging.getLogger(__name__)

def generate_script(heuristics: list[str]) -> str:
    body = "\n".join([f"print('HEURISTIC:{h}')" for h in heuristics])
    return textwrap.dedent(f"""
#@category PentestAI
from ghidra.util.task import ConsoleTaskMonitor
mon = ConsoleTaskMonitor(); prog = currentProgram
fm = prog.getFunctionManager()
for f in fm.getFunctions(True):
    print("FUNC|" + f.getName() + "|" + str(f.getEntryPoint()))
{body}
""")

def run_headless(binary_path: str, heuristics: list[str]) -> dict:
    logger.info(f"Running Ghidra headless analysis on {binary_path}")
    if which("analyzeHeadless") is None:
        logger.warning("Ghidra 'analyzeHeadless' not found in PATH.")
        return {"tool":"ghidra","error":"not found"}
    with tempfile.TemporaryDirectory() as td:
        proj = os.path.join(td, "proj")
        os.makedirs(proj, exist_ok=True)
        sp = os.path.join(td, "script.py")
        with open(sp,"w") as f:
            f.write(generate_script(heuristics))
        
        logger.debug(f"Executing analyzeHeadless command for {binary_path}")
        c,o,e = run(f'analyzeHeadless {proj} tmp -import "{binary_path}" -postScript "{sp}" -scriptlog "{td}/script.log"', timeout=3600)
        
        slog = ""
        try:
            script_log_path = os.path.join(td,"script.log")
            with open(script_log_path) as f:
                slog=f.read()[-100000:]
            logger.debug(f"Successfully read script log from {script_log_path}")
        except FileNotFoundError:
            logger.warning(f"Ghidra script log not found at {script_log_path}")
        except IOError as ex:
            logger.error(f"Error reading Ghidra script log from {script_log_path}: {ex}")
        except Exception as ex:
            logger.error(f"An unexpected error occurred while reading Ghidra script log: {ex}")

        logger.info(f"Ghidra headless analysis finished for {binary_path}")
        return {"tool":"ghidra","code":c,"stdout":o, "stderr":e, "scriptlog": slog}
