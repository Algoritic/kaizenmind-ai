import logging
from .subproc import run, which

logger = logging.getLogger(__name__)

def android_install_and_monkey(apk_path: str, events: int = 1000) -> dict:
    logger.info(f"Starting Android install and monkey testing for APK: {apk_path}")
    if which("adb") is None:
        logger.warning("ADB not found in PATH.")
        return {"tool":"adb","error":"not found"}
    
    res = {}
    commands = [
        ("devices","adb devices"),
        ("install", f"adb install -r {apk_path}"),
        ("monkey", f"adb shell monkey --pct-syskeys 0 {events}")
    ]

    for name, cmd in commands:
        logger.debug(f"Executing ADB command: {name} - {cmd}")
        c,o,e = run(cmd, timeout=1200)
        res[name]={"code":c,"stdout":o, "stderr":e}
        if c != 0:
            logger.error(f"ADB command '{name}' failed with code {c}. Stderr: {e}")
        else:
            logger.info(f"ADB command '{name}' completed successfully.")
    
    logger.info(f"Finished Android install and monkey testing for APK: {apk_path}")
    return res
