from jinja2 import Template
import json
import os
import logging

logger = logging.getLogger(__name__)

HTML_TEMPLATE = """
<!DOCTYPE html>
<html>
<head>
    <title>PentestAI Report - {{ report.project }}</title>
    <style>
        body { font-family: sans-serif; margin: 2em; }
        h1, h2, h3 { color: #333; }
        .section { background-color: #f9f9f9; border: 1px solid #eee; padding: 1em; margin-bottom: 1em; }
        .finding { border-left: 4px solid #f00; padding-left: 1em; margin-top: 0.5em; }
        .severity-critical { border-color: #d9534f; }
        .severity-high { border-color: #f0ad4e; }
        .severity-medium { border-color: #f0ad4e; }
        .severity-low { border-color: #5bc0de; }
        .summary-table { width: 100%; border-collapse: collapse; margin-top: 1em; }
        .summary-table th, .summary-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .summary-table th { background-color: #f2f2f2; }
    </style>
</head>
<body>
    <h1>PentestAI Report - {{ report.project }}</h1>
    <p><strong>Run ID:</strong> {{ report.id }}</p>
    <h2>Summary</h2>
    <table class="summary-table">
        <tr>
            <th>Severity</th>
            <th>Count</th>
        </tr>
        {% for sev, count in report.summary.items() %}
        <tr>
            <td>{{ sev.capitalize() }}</td>
            <td>{{ count }}</td>
        </tr>
        {% endfor %}
    </table>

    <h2>Sections</h2>
    {% for section in report.sections %}
    <div class="section">
        <h3>{{ section.name }}</h3>
        {% if section.findings %}
            {% for finding in section.findings %}
            <div class="finding severity-{{ finding.severity.lower() }}">
                <h4>{{ finding.title }} (Severity: {{ finding.severity.capitalize() }})</h4>
                <p>{{ finding.description }}</p>
                {% if finding.details %}<pre>{{ finding.details }}</pre>{% endif %}
            </div>
            {% endfor %}
        {% else %}
            <p>No findings in this section.</p>
        {% endif %}
    </div>
    {% endfor %}

    <h2>Metadata</h2>
    <pre>{{ report.metadata | tojson(indent=2) }}</pre>

</body>
</html>
"""

def write_outputs(report: dict, out_dir: str):
    logger.info(f"Writing report outputs to {out_dir}")
    os.makedirs(out_dir, exist_ok=True)
    report_json_path = os.path.join(out_dir, f"report_{report['id']}.json")
    report_html_path = os.path.join(out_dir, f"report_{report['id']}.html")

    try:
        with open(report_json_path, "w") as f:
            json.dump(report, f, indent=2)
        logger.info(f"Report JSON written to {report_json_path}")
    except IOError as e:
        logger.error(f"Error writing report JSON to {report_json_path}: {e}")

    try:
        template = Template(HTML_TEMPLATE)
        rendered_html = template.render(report=report)
        with open(report_html_path, "w") as f:
            f.write(rendered_html)
        logger.info(f"Report HTML written to {report_html_path}")
    except Exception as e:
        logger.error(f"Error writing report HTML to {report_html_path}: {e}")

    return report_json_path, report_html_path
